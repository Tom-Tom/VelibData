$(function(){function c(){function c(){$(".leaflet-marker-pane img").remove();for(var b=JSON.parse(localStorage.data),c=0;b.length>c;c++)i(a,b[c]);$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg,events:{load:function(){var a=this.series[0];setInterval(function(){for(var b=JSON.parse(localStorage.data),c=0,d=0,e=0;b.length>e;e++)c+=b[e].available_bikes,d+=b[e].available_bike_stands;var f=c,g=(new Date).getTime();a.addPoint([g,f],!0,!0)},1e4)}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"}}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){var c,a=[],b=(new Date).getTime(),d=JSON.parse(localStorage.data),e=0;for(c=0;d.length>c;c++)e+=d[c].available_bikes;for(c=-19;0>=c;c++)a.push({x:b+1e4*c,y:e});return a}()}]})}function i(a,b){var c=b.position.lat,d=b.position.lng,e=b.bike_stands-(b.available_bike_stands+b.available_bikes),f=100*b.available_bikes/b.bike_stands;return pin=20>=f?"img/bleu_1.svg":40>=f?"img/bleu_2.svg":60>=f?"img/bleu_3.svg":80>=f?"img/bleu_4.svg":"img/bleu_5.svg",null===c||null===d?!1:0===b.available_bikes&&null===b.available_bike_stands?!1:(L.marker([c,d],{icon:L.icon({iconUrl:pin,iconSize:[20,20],iconAnchor:[10,10],popupAnchor:[0,-10],available_bike_stands:b.available_bike_stands,available_bikes:b.available_bikes,broken_stands:e})}).addTo(a).on("click",function(a){var c=a.target.options.icon.options;p[0].y=c.broken_stands,p[1].y=c.available_bike_stands,p[2].y=c.available_bikes,o.name=b.name.slice(8),o.address=b.address,r(p,o)}),void 0)}function r(b,c){var d=b[0].y+b[1].y+b[2].y+" stands";k.text(c.name),l.text(c.address),j.highcharts({chart:{type:"pie",backgroundColor:"transparent",style:{fontFamily:"DINPro",fonSize:"1em"}},credits:{enabled:!1},exporting:{enabled:!1},labels:{items:[{style:{fontFamily:"DINPro"}}],style:{fontFamily:"DINPro"}},legend:{style:{fontFamily:"DINPro"}},plotOptions:{pie:{shadow:!1,center:["50%","50%"],animation:{duration:2e3,easing:"swing"},dataLabels:{style:{fontFamily:"DINPro",fontSize:"1.5em"}},borderColor:"#d0eaf6",borderWidth:4,startAngle:Math.floor(359*Math.random()+0)}},series:[{data:b,size:"75%",innerSize:"65%",name:"Total"}],title:{text:d,verticalAlign:"middle",style:{fontFamily:"DINPro",fontSize:"1.5em"}},tooltip:{hideDelay:100,headerFormat:"",pointFormat:'<span style="color:{point.color};font-weight:bold;font-size:1.2em;">{point.y}</span>',footerFormat:"",style:{fontFamily:"DINPro"}}}),$("body").addClass("screenSplit"),q.restart(),setTimeout(function(){a.invalidateSize()},500)}var a=L.mapbox.map("map","heymath.velib");a.attributionControl.removeFrom(a);var b="select * from html where url='https://api.jcdecaux.com/vls/v1/stations?apiKey=a529d3371c450b3ab44a9281345bcb27e8f47868&contract=Paris'";jyql(b,function(b,c){localStorage.data=c.query.results.body.p;for(var d=JSON.parse(localStorage.data),e=0;d.length>e;e++)i(a,d[e])}),setInterval(function(){jyql(b,function(a,b){localStorage.data=b.query.results.body.p})},9e3),$("#timeline nav ul li").on("click",function(){$("#timeline nav ul li.active").removeClass("active"),$(this).addClass("active")}),Highcharts.setOptions({global:{useUTC:!1}}),c(),$("#timeline nav ul li:nth-child(1)").on("click",function(){c()}),$("#timeline nav ul li:nth-child(2)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x+864e5)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{allowPointSelect:!0,color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"},select:{lineColor:"#1b6d93",lineWidth:4}}},events:{click:function(b){url="http://kevinlarosa.fr:4000/?dateStart="+(b.point.x-1)+"&dateEnd="+(b.point.x+1),$.ajax({url:url,type:"GET",dataType:"json",success:function(b){$(".leaflet-marker-pane img").remove();for(var c=0;b[0].stations.length>c;c++)i(a,b[0].stations[c])},error:function(){console.log("ERROR")}})}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){for(var a=[],b=JSON.parse(localStorage.data1),c=0;24>c;c++)a.push({x:Date.parse(b[c].timestamp),y:b[c].velib});return a}()}]})}),$("#timeline nav ul li:nth-child(3)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x+864e5)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{allowPointSelect:!0,color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"},select:{lineColor:"#1b6d93",lineWidth:4}}},events:{click:function(b){url="http://kevinlarosa.fr:4000/?dateStart="+(b.point.x-1)+"&dateEnd="+(b.point.x+1),$.ajax({url:url,type:"GET",dataType:"json",success:function(b){$(".leaflet-marker-pane img").remove();for(var c=0;b[0].stations.length>c;c++)i(a,b[0].stations[c])},error:function(){console.log("ERROR")}})}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){for(var a=[],b=JSON.parse(localStorage.data7),c=0;21>c;c++)a.push({x:Date.parse(b[c].timestamp),y:b[c].velib});return a}()}]})}),$("#timeline nav ul li:nth-child(4)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x+864e5)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{allowPointSelect:!0,color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"},select:{lineColor:"#1b6d93",lineWidth:4}}},events:{click:function(b){url="http://kevinlarosa.fr:4000/?dateStart="+(b.point.x-2e3)+"&dateEnd="+(b.point.x+2e3),$.ajax({url:url,type:"GET",dataType:"json",success:function(b){$(".leaflet-marker-pane img").remove();for(var c=0;b[0].stations.length>c;c++)i(a,b[0].stations[c])},error:function(){console.log("ERROR")}})}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){for(var a=[],b=JSON.parse(localStorage.data30),c=0;30>c;c++)a.push({x:Date.parse(b[c].timestamp),y:b[c].velib});return a}()}]})});for(var d=JSON.parse(localStorage.data),e=[],f=0;d.length>f;f++)e[f]={value:d[f].name.slice(8).toLowerCase(1),id:d[f].number};$("#search").typeahead({name:"station",local:e}),$("#search").on("typeahead:selected",function(a,b){for(f=0;d.length>f;f++)if(d[f].number===b.id){var c=d[f],e=c.bike_stands-(c.available_bike_stands+c.available_bikes);p[0].y=e,p[1].y=c.available_bike_stands,p[2].y=c.available_bikes,o.name=c.name.slice(8),o.address=c.address,r(p,o),f=d.length}}),a.on("click",function(){$("body").removeClass("screenSplit"),setTimeout(function(){a.invalidateSize()},500)});var j=$("#donutContainer"),k=$("#titreStation"),l=$("#soustitreStation"),m=["#1b6d93","#64bee7","#8fceea","#d0eaf6"],n=["stands endommag\u00e9s","stands vides","v\u00e9los disponibles"],o={name:"",address:""},p=[{y:0,color:m[0],name:n[0],categories:[0]},{y:0,color:m[1],name:n[1],categories:[1]},{y:0,color:m[2],name:n[2],categories:[2]}],q=new TimelineLite;q.from(k,.5,{left:"-9999px"}).from(l,.5,{left:"9999px"},"-=0.25").from(j,1,{scale:0},"-=0.25")}var a=moment(),b=moment().subtract("hours",38);url="http://kevinlarosa.fr:4000/timeline?dateStart="+b+"&dateEnd="+a,$.ajax({url:url,type:"GET",dataType:"json",success:function(a){localStorage.data1=JSON.stringify(a)},error:function(a){console.log("erreur : "+a.statusText+" "+a.status)}});var a=moment(),b=moment().subtract("days",7);url="http://kevinlarosa.fr:4000/timeline7?dateStart="+b+"&dateEnd="+a,$.ajax({url:url,type:"GET",dataType:"json",success:function(a){localStorage.data7=JSON.stringify(a)},error:function(){}});var b=moment().subtract("days",14);url="http://kevinlarosa.fr:4000/timeline30?dateStart="+b+"&dateEnd="+a,$.ajax({url:url,type:"GET",dataType:"json",success:function(a){localStorage.data30=JSON.stringify(a)},error:function(){}}),c(),$("#loader").remove(),setTimeout(function(){$("#gate_top , #gate_bottom, #loading_header").addClass("open")},500)});
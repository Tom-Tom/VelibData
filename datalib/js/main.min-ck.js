$(function(){function e(){function e(){$(".leaflet-marker-pane img").remove();for(var e=JSON.parse(localStorage.data),n=0;e.length>n;n++)t(r,e[n]);$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg,events:{load:function(){var e=this.series[0];setInterval(function(){for(var t=JSON.parse(localStorage.data),n=0,r=0,i=0;t.length>i;i++)n+=t[i].available_bikes,r+=t[i].available_bike_stands;var s=n,o=(new Date).getTime();e.addPoint([o,s],!0,!0)},1e4)}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"}}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){var e,t=[],n=(new Date).getTime(),r=JSON.parse(localStorage.data),i=0;for(e=0;r.length>e;e++)i+=r[e].available_bikes;for(e=-19;0>=e;e++)t.push({x:n+1e4*e,y:i});return t}()}]})}function t(e,t){var r=t.position.lat,i=t.position.lng,s=t.bike_stands-(t.available_bike_stands+t.available_bikes),o=100*t.available_bikes/t.bike_stands;return pin=20>=o?"img/bleu_1.svg":40>=o?"img/bleu_2.svg":60>=o?"img/bleu_3.svg":80>=o?"img/bleu_4.svg":"img/bleu_5.svg",null===r||null===i?!1:0===t.available_bikes&&null===t.available_bike_stands?!1:(L.marker([r,i],{icon:L.icon({iconUrl:pin,iconSize:[20,20],iconAnchor:[10,10],popupAnchor:[0,-10],available_bike_stands:t.available_bike_stands,available_bikes:t.available_bikes,broken_stands:s})}).addTo(e).on("click",function(e){var r=e.target.options.icon.options;d[0].y=r.broken_stands,d[1].y=r.available_bike_stands,d[2].y=r.available_bikes,p.name=t.name.slice(8),p.address=t.address,n(d,p)}),void 0)}function n(e,t){var n=e[0].y+e[1].y+e[2].y+" stands";f.text(t.name),l.text(t.address),a.highcharts({chart:{type:"pie",backgroundColor:"transparent",style:{fontFamily:"DINPro",fonSize:"1em"}},credits:{enabled:!1},exporting:{enabled:!1},labels:{items:[{style:{fontFamily:"DINPro"}}],style:{fontFamily:"DINPro"}},legend:{style:{fontFamily:"DINPro"}},plotOptions:{pie:{shadow:!1,center:["50%","50%"],animation:{duration:2e3,easing:"swing"},dataLabels:{style:{fontFamily:"DINPro",fontSize:"1.5em"}},borderColor:"#d0eaf6",borderWidth:4,startAngle:Math.floor(359*Math.random()+0)}},series:[{data:e,size:"75%",innerSize:"65%",name:"Total"}],title:{text:n,verticalAlign:"middle",style:{fontFamily:"DINPro",fontSize:"1.5em"}},tooltip:{hideDelay:100,headerFormat:"",pointFormat:'<span style="color:{point.color};font-weight:bold;font-size:1.2em;">{point.y}</span>',footerFormat:"",style:{fontFamily:"DINPro"}}}),$("body").addClass("screenSplit"),v.restart(),setTimeout(function(){r.invalidateSize()},500)}var r=L.mapbox.map("map","heymath.velib");r.attributionControl.removeFrom(r);var i="select * from html where url='https://api.jcdecaux.com/vls/v1/stations?apiKey=a529d3371c450b3ab44a9281345bcb27e8f47868&contract=Paris'";jyql(i,function(e,n){localStorage.data=n.query.results.body.p;for(var i=JSON.parse(localStorage.data),s=0;i.length>s;s++)t(r,i[s])}),setInterval(function(){jyql(i,function(e,t){localStorage.data=t.query.results.body.p})},9e3),$("#timeline nav ul li").on("click",function(){$("#timeline nav ul li.active").removeClass("active"),$(this).addClass("active")}),Highcharts.setOptions({global:{useUTC:!1}}),e(),$("#timeline nav ul li:nth-child(1)").on("click",function(){e()}),$("#timeline nav ul li:nth-child(2)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x+864e5)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{allowPointSelect:!0,color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"},select:{lineColor:"#1b6d93",lineWidth:4}}},events:{click:function(e){url="http://kevinlarosa.fr:4000/?dateStart="+(e.point.x-1)+"&dateEnd="+(e.point.x+1),$.ajax({url:url,type:"GET",dataType:"json",success:function(e){$(".leaflet-marker-pane img").remove();for(var n=0;e[0].stations.length>n;n++)t(r,e[0].stations[n])},error:function(){console.log("ERROR")}})}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){for(var e=[],t=JSON.parse(localStorage.data1),n=0;24>n;n++)e.push({x:Date.parse(t[n].timestamp),y:t[n].velib});return e}()}]})}),$("#timeline nav ul li:nth-child(3)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x+864e5)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{allowPointSelect:!0,color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"},select:{lineColor:"#1b6d93",lineWidth:4}}},events:{click:function(e){url="http://kevinlarosa.fr:4000/?dateStart="+(e.point.x-1)+"&dateEnd="+(e.point.x+1),$.ajax({url:url,type:"GET",dataType:"json",success:function(e){$(".leaflet-marker-pane img").remove();for(var n=0;e[0].stations.length>n;n++)t(r,e[0].stations[n])},error:function(){console.log("ERROR")}})}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){for(var e=[],t=JSON.parse(localStorage.data7),n=0;21>n;n++)e.push({x:Date.parse(t[n].timestamp),y:t[n].velib});return e}()}]})}),$("#timeline nav ul li:nth-child(4)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x+864e5)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{allowPointSelect:!0,color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"},select:{lineColor:"#1b6d93",lineWidth:4}}},events:{click:function(e){url="http://kevinlarosa.fr:4000/?dateStart="+(e.point.x-2e3)+"&dateEnd="+(e.point.x+2e3),$.ajax({url:url,type:"GET",dataType:"json",success:function(e){$(".leaflet-marker-pane img").remove();for(var n=0;e[0].stations.length>n;n++)t(r,e[0].stations[n])},error:function(){console.log("ERROR")}})}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){for(var e=[],t=JSON.parse(localStorage.data30),n=0;30>n;n++)e.push({x:Date.parse(t[n].timestamp),y:t[n].velib});return e}()}]})});for(var s=JSON.parse(localStorage.data),o=[],u=0;s.length>u;u++)o[u]={value:s[u].name.slice(8).toLowerCase(1),id:s[u].number};$("#search").typeahead({name:"station",local:o}),$("#search").on("typeahead:selected",function(e,t){for(u=0;s.length>u;u++)if(s[u].number===t.id){var r=s[u],i=r.bike_stands-(r.available_bike_stands+r.available_bikes);d[0].y=i,d[1].y=r.available_bike_stands,d[2].y=r.available_bikes,p.name=r.name.slice(8),p.address=r.address,n(d,p),u=s.length}}),r.on("click",function(){$("body").removeClass("screenSplit"),setTimeout(function(){r.invalidateSize()},500)});var a=$("#donutContainer"),f=$("#titreStation"),l=$("#soustitreStation"),c=["#1b6d93","#64bee7","#8fceea","#d0eaf6"],h=["stands endommagés","stands vides","vélos disponibles"],p={name:"",address:""},d=[{y:0,color:c[0],name:h[0],categories:[0]},{y:0,color:c[1],name:h[1],categories:[1]},{y:0,color:c[2],name:h[2],categories:[2]}],v=new TimelineLite;v.from(f,.5,{left:"-9999px"}).from(l,.5,{left:"9999px"},"-=0.25").from(a,1,{scale:0},"-=0.25")}var t=moment(),n=moment().subtract("hours",38);url="http://kevinlarosa.fr:4000/timeline?dateStart="+n+"&dateEnd="+t,$.ajax({url:url,type:"GET",dataType:"json",success:function(e){localStorage.data1=JSON.stringify(e)},error:function(e){console.log("erreur : "+e.statusText+" "+e.status)}});var t=moment(),n=moment().subtract("days",7);url="http://kevinlarosa.fr:4000/timeline7?dateStart="+n+"&dateEnd="+t,$.ajax({url:url,type:"GET",dataType:"json",success:function(e){localStorage.data7=JSON.stringify(e)},error:function(){}});var n=moment().subtract("days",14);url="http://kevinlarosa.fr:4000/timeline30?dateStart="+n+"&dateEnd="+t,$.ajax({url:url,type:"GET",dataType:"json",success:function(e){localStorage.data30=JSON.stringify(e)},error:function(){}}),e(),$("#loader").remove(),setTimeout(function(){$("#gate_top , #gate_bottom, #loading_header").addClass("open")},500)});
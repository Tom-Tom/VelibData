$(function(){function u(e){var t=new Date(e),n=t.getHours(),r=t.getMinutes(),i=t.getSeconds(),s=n+"h:"+r+"m:"+i+"s:";return s}function a(e){var t=(new Date).getTime();t-=e;return u(t)}function f(e,t,n){var r=t.position.lat,i=t.position.lng,s=t.name.slice(7),o=t.bike_stands-(t.available_bike_stands+t.available_bikes),f="<strong>Address : </strong>"+t.address;f=f+"<br/><strong>Available bike stands : </strong>"+t.available_bike_stands;f=f+"<br/><strong>Available bikes : </strong>"+t.available_bikes;f=f+"<br/><strong>Last update : </strong>"+u(t.last_update);f=f+"("+a(t.last_update)+"sec ago)";var d=100*t.available_bikes/t.bike_stands,v="#333333";d<=20?v="#2B00DD":d<=40?v="#5500BB":d<=60?v="#800099":d<=80?v="#AA0077":d<=100&&(v="#D50055");if(n==="circle"){var m={color:v,opacity:.6,weight:5,fillColor:"#000000",fillOpacity:.4};L.circle(t.position,50,m).addTo(e)}else L.mapbox.markerLayer({type:"Feature",geometry:{type:"Point",coordinates:[i,r]},properties:{title:s,description:f,"marker-size":"small","marker-color":v,"marker-symbol":"bicycle",available_bike_stands:t.available_bike_stands,available_bikes:t.available_bikes,broken_stands:o}}).addTo(e).on("click",function(e){e.layer.unbindPopup();var t=e.layer.feature,n=[{y:t.properties.broken_stands,color:c[0],name:h[0],categories:[0]},{y:t.properties.available_bike_stands,color:c[1],name:h[1],categories:[1]},{y:t.properties.available_bikes,color:c[2],name:h[2],categories:[2]}];l.removeClass("no_opacity");p(n)})}function p(e){var t=e[0].y+e[1].y+e[2].y+" stands";l.highcharts({exporting:{enabled:!1},credits:{enabled:!1},chart:{type:"pie",backgroundColor:"transparent"},title:{text:t,verticalAlign:"middle"},plotOptions:{pie:{shadow:!1,center:["50%","50%"],animation:{duration:2e3,easing:"swing"}}},tooltip:{valueSuffix:""},series:[{data:e,size:"80%",innerSize:"70%",name:"Total"}]})}var e=L.mapbox.map("map","etiwiti.panam");e.attributionControl.removeFrom(e);var t=moment(),n=moment().subtract("hours",3);url="http://kevinlarosa.fr:4000/?dateStart="+n+"&dateEnd="+t;$.ajax({url:url,type:"GET",dataType:"json",success:function(e){for(var t=0;t<e.length;t++){var n=0;for(var r=0;r<e[t].stations.length;r++)n+=e[t].stations[r].available_bikes;console.log(n)}},error:function(){console.log("Fail load data API")}});var r="select * from html where url='https://api.jcdecaux.com/vls/v1/stations?apiKey=a529d3371c450b3ab44a9281345bcb27e8f47868&contract=Paris'";jyql(r,function(t,n){localStorage.data=n.query.results.body.p;var r="",i=JSON.parse(localStorage.data),s=0,o=0;for(var u=0;u<i.length;u++){f(e,i[u],r);s+=i[u].available_bikes;o+=i[u].available_bike_stands}});setInterval(function(){jyql(r,function(e,t){localStorage.data=t.query.results.body.p})},9e3);Highcharts.setOptions({global:{useUTC:!1}});$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg,events:{load:function(){var e=this.series[0];setInterval(function(){var t=JSON.parse(localStorage.data),n=0,r=0;for(var i=0;i<t.length;i++){n+=t[i].available_bikes;r+=t[i].available_bike_stands}var s=n,o=(new Date).getTime();e.addPoint([o,s],!0,!0)},1e4)}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"}}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){var e=[],t=(new Date).getTime(),n,r=JSON.parse(localStorage.data),i=0;for(n=0;n<r.length;n++)i+=r[n].available_bikes;for(n=-19;n<=0;n++)e.push({x:t+n*1e4,y:i});return e}()}]});$("#timeline nav ul li:nth-child(1)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg,events:{load:function(){var e=this.series[0];setInterval(function(){var t=JSON.parse(localStorage.data),n=0,r=0;for(var i=0;i<t.length;i++){n+=t[i].available_bikes;r+=t[i].available_bike_stands}var s=n,o=(new Date).getTime();e.addPoint([o,s],!0,!0)},1e4)}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"}}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){var e=[],t=(new Date).getTime(),n,r=JSON.parse(localStorage.data),i=0;for(n=0;n<r.length;n++)i+=r[n].available_bikes;for(n=-19;n<=0;n++)e.push({x:t+n*1e4,y:i});return e}()}]})});$("#timeline nav ul li:nth-child(2)").on("click",function(){$("#graph").highcharts({chart:{type:"spline",backgroundColor:"transparent",height:"190",animation:Highcharts.svg,events:{load:function(){}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",lineWidth:0,tickPixelInterval:100,labels:{style:{fontFamily:"DINPro"}}},yAxis:{title:{text:""},gridLineWidth:0,labels:{enabled:!1}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.numberFormat(this.y,2)+"<br/>le "+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)},style:{padding:10,fontFamily:"DINPro"},crosshairs:[{width:4,color:"#1b6d93"}]},plotOptions:{series:{color:"#64bee7",marker:{fillColor:"#edf5fb",lineColor:"#64bee7",lineWidth:4,states:{hover:{lineColor:"#1b6d93"}}}}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Nombre de velib':",lineWidth:6,marker:{radius:9},data:function(){var e=[],t=(new Date).getTime(),n,r=JSON.parse(localStorage.data),i=0;for(n=0;n<r.length;n++)i+=r[n].available_bikes;for(n=-19;n<=0;n++)e.push({x:t+n*1e4,y:i});return e}()}]})});var i=JSON.parse(localStorage.data),s=[];for(var o=0;o<i.length;o++)s[o]=i[o].name.slice(8).toLowerCase(1);$("#search").typeahead({name:"station",local:s});var l=$("#donutContainer"),c=["#1b6d93","#64bee7","#8fceea","#d0eaf6"],h=["stands endommagés","stands vides","vélos disponibles"]});